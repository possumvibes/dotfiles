#!/bin/bash

## XOrg AutoStart Script #####################
#

# Check Xresources for our autostart flag,
# and only continue if it isn't present.
xresource_name='session.autostarted'
xrdb -query | grep "$xresource_name" >/dev/null && exit 0

_check()
{
  command -v "$1" > /dev/null
}

## Sound
_check pipewire && pipewire &

# Screensaver
xset s 300 5
_check xss-lock && xss-lock -l -- lockscreen &

## Compositor
_check picom && picom &

## Blue light shift
_check redshift &&  redshift &

# Load Xresources
xrdb -I "$HOME" -merge "$HOME"/.Xresources

# WM-specific config
#
if [ "$DESKTOP_SESSION" == "bspwm" ]; then

  # hotkey daemon
  _check sxhkd && env SXHKD_SHELL='sh' sxhkd

	# notifications
  _check dunst && dunst &

  # wallpaper!
  _check feh && [ -f ~/.fehbg ] && ~/.fehbg &

  if _check polybar
  then
    # Make sure there are no running instances
    pkill -x polybar

    ## Restart the sucker
    ~/.config/polybar/launch.sh &
  fi
fi

# Set the flag in xresources to prevent duplicate executions
xrdb -merge <<< "$xresource_name":true
